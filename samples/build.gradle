import org.jetbrains.kotlin.konan.target.HostManager

buildscript {
    ext.kotlin_version = '1.3.0-rc-116'

    repositories {
        mavenCentral()
        maven { url 'https://dl.bintray.com/kotlin/kotlin-dev' }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-eap' }
    }

    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        mavenCentral()
        maven { url 'https://dl.bintray.com/kotlin/kotlin-dev' }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-eap' }
    }
}

// A shorty-cut for evaluation .def file path based on the source set.
def defFilePath(def sourceSet, String defFileName) {
    if (java.nio.file.Paths.get(defFileName).isAbsolute())
        return defFileName

    return java.nio.file.Paths.get('src', "${alias}Main", 'c_interop', defFileName).toString()
}

// A short-cut to add a Kotlin/Native run task.
def createRunTask(def subproject, String name, def target, Closure configureClosure = {}) {
    def task = subproject.tasks.create(name, RunKotlinNativeTask, subproject, target)
    task.configure(configureClosure)
    return task
}

class RunKotlinNativeTask extends DefaultTask {
    private final def myProject
    private final def myTarget

    String buildType = 'release'
    private List<String> myArgs = []

    void args(Object... args) {
        this.myArgs = args.each { it.toString() }
    }

    @javax.inject.Inject
    RunKotlinNativeTask(def project, def target) {
        this.myProject = project
        this.myTarget = target
    }

    Task configure(Closure configureClosure) {
        super.configure(configureClosure)
        this.dependsOn("link${buildType.capitalize()}Executable${myTarget.targetName.capitalize()}")
    }

    @TaskAction
    void run() {
        def programFile = myTarget.compilations.main.getBinary('EXECUTABLE', buildType)
        def arguments = myArgs
        myProject.exec {
            executable programFile
            args arguments
        }
    }
}
